<?xml version="1.0" encoding="UTF-8" ?><!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" ><mapper namespace="com.hiveelpay.dal.dao.mapper.BizOrderMapper">    <sql id="table_name">        t_biz_order    </sql>    <sql id="all_columns">        id,        customerId, bizOrderNo, productId, productName, docId, amount, commissionAmount, productType, serviceLength,        serviceLengthUnit, orderStatus, firstBillDate, payAmount, currency, mchId, channelId, paySuccessTime, remark, invalidBizOrderNo,        createAt, lastUpdateAt    </sql>    <sql id="save_columns">        customerId, bizOrderNo, productId, productName, docId, amount, commissionAmount, productType, serviceLength,        serviceLengthUnit, orderStatus, firstBillDate, payAmount, currency, mchId, channelId, paySuccessTime, remark, invalidBizOrderNo    </sql>    <insert id="save" parameterType="com.hiveelpay.dal.dao.model.BizOrder" flushCache="true">        INSERT INTO        <include refid="table_name"/>        (        <include refid="save_columns"/>        )VALUE        (        #{order.customerId},#{order.bizOrderNo}, #{order.productId}, #{order.productName},#{order.docId},        #{order.amount},#{order.commissionAmount},#{order.productType}, #{order.serviceLength},        #{order.serviceLengthUnit}, #{order.orderStatus},#{order.firstBillDate},        #{order.payAmount},#{order.currency}, #{order.mchId},        #{order.channelId},#{order.paySuccessTime},#{order.remark},#{order.invalidBizOrderNo}        )    </insert>    <update id="updatePaySuccess" flushCache="true">        UPDATE        <include refid="table_name"/>        <set>            orderStatus=#{toStatus}, paySuccessTime=now()        </set>        <where>            bizOrderNo=#{bizOrderNo} AND orderStatus=#{fromStatus}        </where>    </update>    <update id="updatePayFailed" flushCache="true">        UPDATE        <include refid="table_name"/>        <set>            orderStatus=#{toStatus}        </set>        <where>            bizOrderNo=#{bizOrderNo} and orderStatus=#{fromStatus}        </where>    </update>    <update id="checkOrderServiceEnd" parameterType="com.hiveelpay.common.enumm.BizOrderStatus" flushCache="true">        update        <include refid="table_name"/>        <set>            orderStatus = #{serviceEnd}        </set>        <where>            <![CDATA[  serviceEndTime<= now() and id >0  ]]>        </where>    </update>    <update id="checkInserviceOrders">        UPDATE        <include refid="table_name"/>        <set>            orderStatus = #{toStatus}        </set>        <where>            bizOrderNo IN (            <foreach collection="willInServiceBizOrderIds" separator="," item="item">                #{item}            </foreach>            )            <![CDATA[ AND             orderStatus = #{fromStatus}             ]]>        </where>    </update>    <update id="updateBizOrdersStatus">        UPDATE        <include refid="table_name"/>        <set>            orderStatus = #{toStatus}        </set>        <where>            bizOrderNo IN (            <foreach collection="serviceEndBizOrderNoList" separator="," item="item">                #{item}            </foreach>            ) and orderStatus = #{fromStatus}        </where>    </update>    <update id="updateEmptyInvalidBizOrderNo">        UPDATE        <include refid="table_name"/>        <set>            invalidBizOrderNo = null        </set>        <where>            bizOrderNo = #{validBizOrderNo}        </where>    </update>    <update id="updateEmptyInvalidBizOrderNoByBizOrderNo">        UPDATE        <include refid="table_name"/>        <set>            invalidBizOrderNo = null        </set>        <where>            invalidBizOrderNo = #{bizOrderNo}        </where>    </update>    <update id="updateServiceEndTime">        UPDATE        <include refid="table_name"/>        SET serviceEndTime = now()        <where>            bizOrderNo = #{invalidBizOrderNo}        </where>    </update>    <select id="countTotal" resultType="_int" useCache="false">        select count(id) from        <include refid="table_name"/>        <where>            customerId = #{customerId}            <if test="kindNameSet  != null">                and productType in (                <foreach collection="kindNameSet" item="productType" separator=",">                    #{productType}                </foreach>                )            </if>        </where>    </select>    <select id="loadHistoryOrder" resultType="com.hiveelpay.dal.dao.model.BizOrder" useCache="true">        select        <include refid="all_columns"/>        from        <include refid="table_name"/>        <where>            customerId = #{customerId}            <if test="kindNameSet  != null">                and productType in (                <foreach collection="kindNameSet" item="productType" separator=",">                    #{productType}                </foreach>                )            </if>        </where>        order by createAt desc        <if test="hiveelPage!= null ">            limit #{hiveelPage.offset}, #{hiveelPage.perPageSize}        </if>    </select>    <select id="selectByBizOrderNo" resultType="com.hiveelpay.dal.dao.model.BizOrder" useCache="true">        SELECT        <include refid="all_columns"/>        FROM        <include refid="table_name"/>        <where>            bizOrderNo = #{bizOrderNo}        </where>    </select>    <select id="searchBizOrderCount" resultType="int" useCache="true">        SELECT count(id)        FROM        <include refid="table_name"/>        <where>            <if test="bizOrder.mchId !=null and bizOrder.mchId !=''">                mchId = #{bizOrder.mchId}            </if>            <if test="bizOrder.bizOrderNo !=null and bizOrder.bizOrderNo !=''">                and bizOrderNo = #{bizOrder.bizOrderNo}            </if>            <if test="bizOrder.orderStatus !=null">                and orderStatus = #{bizOrder.orderStatus}            </if>            <if test="bizOrder.productId !=null and bizOrder.productId !=''">                and productId = #{bizOrder.productId}            </if>        </where>    </select>    <select id="searchBizOrder" resultType="com.hiveelpay.dal.dao.model.BizOrder" useCache="true">        select        <include refid="all_columns"/>        from        <include refid="table_name"/>        <where>            <if test="bizOrder.mchId !=null and bizOrder.mchId !=''">                mchId = #{bizOrder.mchId}            </if>            <if test="bizOrder.bizOrderNo !=null and bizOrder.bizOrderNo !=''">                and bizOrderNo = #{bizOrder.bizOrderNo}            </if>            <if test="bizOrder.orderStatus !=null">                and orderStatus = #{bizOrder.orderStatus}            </if>            <if test="bizOrder.productId !=null and bizOrder.productId !=''">                and productId = #{bizOrder.productId}            </if>        </where>        order by createAt desc        limit #{offset}, #{limit}    </select>    <select id="findByStatus" resultType="com.hiveelpay.dal.dao.model.BizOrder" useCache="false">        select        <include refid="all_columns"/>        from        <include refid="table_name"/>        <where>            customerId = #{customerId} and orderStatus = #{status}        </where>    </select>    <select id="findCustomerValidMembershipOrder" resultType="com.hiveelpay.dal.dao.model.BizOrder">        select        <include refid="all_columns"/>        from        <include refid="table_name"/>        <where>            customerId = #{customerId} and productType = #{payProductTypeName}        </where>    </select>    <select id="findCustomerBizOrder" resultType="com.hiveelpay.dal.dao.model.BizOrder" useCache="true">        select        <include refid="all_columns"/>        from        <include refid="table_name"/>        <where>            bizOrderNo = #{bizOrderId} and customerId = #{customerId}        </where>    </select>    <select id="findByBizOrderStatus" resultType="com.hiveelpay.dal.dao.model.BizOrder" useCache="false">        select        <include refid="all_columns"/>        from        <include refid="table_name"/>        <where>            <![CDATA[ orderStatus = #{currentStatus} ]]>        </where>    </select>    <select id="findHasInvalidBizOrderNos" resultType="com.hiveelpay.dal.dao.model.BizOrder">        select        <include refid="all_columns"/>        from        <include refid="table_name"/>        <where>            invalidBizOrderNo is not null        </where>    </select>    <select id="findWillInServiceBizOrderIds" resultType="com.hiveelpay.dal.dao.model.BizOrder">        select        <include refid="all_columns"/>        from        <include refid="table_name"/>        <where>            <![CDATA[          (orderStatus = #{paySuccessed}          ]]>        </where>    </select>    <select id="countMerchantOrders" resultType="_int">        select count(id) from        <include refid="table_name"/>        <where>            mchId = #{mchId}        </where>    </select>    <select id="loadMerchantOrders" resultType="com.hiveelpay.dal.dao.model.BizOrder">        select        <include refid="all_columns"/>        from        <include refid="table_name"/>        <where>            mchId = #{mchId}        </where>        order by createAt desc        <if test="hiveelPage !=null">            limit #{hiveelPage.offset}, #{hiveelPage.perPageSize}        </if>    </select>    <select id="searchBizOrdersCount" resultType="_int">        <bind name="keyword_like" value="'%'+searchRequest.keyWord+'%'"/>        SELECT count(t.id)        FROM t_biz_order t        LEFT JOIN t_service_time t2 ON t.bizOrderNo = t2.bizOrderNo        LEFT JOIN t_biz_car t3 ON t.bizOrderNo = t3.bizOrderNo        <where>            1=1            <if test="searchRequest.mchId !=null and  searchRequest.mchId !=''">                AND t.mchId = #{searchRequest.mchId}            </if>            <if test="statusSet !=null">                AND t.orderStatus IN (                <foreach collection="statusSet" item="item" separator=",">                    #{item}                </foreach>                )            </if>            <if test="searchRequest.startDateStr !=null and searchRequest.startDateStr != ''">                AND  <![CDATA[  t2.serviceStartTime >=  STR_TO_DATE( #{searchRequest.startDateStr},'%m%d%Y')  ]]>            </if>            <if test="searchRequest.endDateStr !=null and searchRequest.endDateStr != ''">                AND  <![CDATA[  t2.serviceEndTime <= STR_TO_DATE( #{searchRequest.endDateStr},'%m%d%Y') ]]>            </if>            <if test="searchRequest.keyWord != null and searchRequest.keyWord != ''">                AND (                t.bizOrderNo LIKE #{keyword_like}                OR t3.carId LIKE #{keyword_like}                OR t3.zipcode LIKE #{keyword_like}                )            </if>            <if test="searchRequest.productType !=null and searchRequest.productType!=''">                AND productType = #{searchRequest.productType}            </if>        </where>    </select>    <select id="searchBizOrders" resultType="com.hiveelpay.dal.dao.model.BizOrder" fetchSize="100">        <bind name="keyword_like" value="'%'+searchRequest.keyWord+'%'"/>        SELECT t.* FROM t_biz_order t        LEFT JOIN t_service_time t2 ON t.bizOrderNo = t2.bizOrderNo        LEFT JOIN t_biz_car t3 ON t.bizOrderNo = t3.bizOrderNo        <where>            1=1            <if test="searchRequest.mchId !=null and  searchRequest.mchId !=''">                AND t.mchId = #{searchRequest.mchId}            </if>            <if test="statusSet !=null">                AND t.orderStatus IN (                <foreach collection="statusSet" item="item" separator=",">                    #{item}                </foreach>                )            </if>            <if test="searchRequest.startDateStr !=null and searchRequest.startDateStr != ''">                AND  <![CDATA[  t2.serviceStartTime >=  STR_TO_DATE( #{searchRequest.startDateStr},'%m%d%Y')  ]]>            </if>            <if test="searchRequest.endDateStr !=null and searchRequest.endDateStr != ''">                AND  <![CDATA[  t2.serviceEndTime <= STR_TO_DATE( #{searchRequest.endDateStr},'%m%d%Y') ]]>            </if>            <if test="searchRequest.keyWord != null and searchRequest.keyWord != ''">                AND (                t.bizOrderNo LIKE #{keyword_like}                OR t3.carId LIKE #{keyword_like}                OR t3.zipcode LIKE #{keyword_like}                )            </if>            <if test="searchRequest.productType !=null and searchRequest.productType!=''">                and productType = #{searchRequest.productType}            </if>        </where>        order by t2.serviceStartTime ASC, t.createAt ASC        <if test="page!=null">            limit #{page.offset}, #{page.perPageSize}        </if>    </select>    <select id="selectByBizOrderNoList" resultType="com.hiveelpay.dal.dao.model.BizOrder" fetchSize="100">        SELECT        <include refid="all_columns"/>        FROM        <include refid="table_name"/>        <where>            bizOrderNo IN            (            <foreach collection="bizOrderNoList" separator="," item="item">                #{item}            </foreach>            )        </where>    </select>    <select id="findBizOrders" resultType="com.hiveelpay.dal.dao.model.BizOrder" fetchSize="100">        SELECT        <include refid="all_columns"/>        FROM        <include refid="table_name"/>        <where>            bizOrderNo IN (            <foreach collection="bizOrderSets" item="item" separator=",">                #{item}            </foreach>            )        </where>    </select>    <select id="findByCarId" resultType="com.hiveelpay.dal.dao.model.BizOrder" useCache="false" fetchSize="50">        SELECT        <include refid="all_columns"/>        FROM        <include refid="table_name"/>        <where>            docId=#{carId}            <if test="statusSet!=null">                AND orderStatus IN (                <foreach collection="statusSet" item="item" separator=",">                    #{item}                </foreach>                )            </if>        </where>    </select>    <select id="searchBizOrdersByCustomerId" resultType="com.hiveelpay.dal.dao.model.BizOrder" useCache="true">        SELECT        <include refid="all_columns"/>        FROM        <include refid="table_name"/>        <where>            customerId =#{customerId}            <if test="statusSet!=null">                AND orderStatus IN (                <foreach collection="statusSet" item="item" separator=",">                    #{item}                </foreach>                )            </if>            <if test="productTypeName !=null and productTypeName != ''">                AND productType = #{productTypeName}            </if>        </where>    </select>    <select id="queryValidBizOrders" resultType="com.hiveelpay.dal.dao.model.BizOrder" useCache="true">        SELECT        <include refid="all_columns"/>        FROM        <include refid="table_name"/>        <where>            (            <foreach collection="serviceTypes" item="st" separator="or">                productType = #{st}            </foreach>            )            AND orderStatus IN (            <foreach collection="statusSet" item="item" separator=",">                #{item}            </foreach>            )        </where>    </select>    <select id="queryBizOrders" resultType="long" useCache="true">        SELECT        sum(payAmount)        FROM        <include refid="table_name"/>        <where>            orderStatus IN (            <foreach collection="statusSet" item="item" separator=",">                #{item}            </foreach>            )            <![CDATA[  AND  createAt >= #{startDate} AND createAt < #{endDate}  AND productType = #{productType} ]]>        </where>    </select>    <select id="findLatestByProductName" resultType="com.hiveelpay.dal.dao.model.BizOrder">        SELECT        <include refid="all_columns"/>        FROM        <include refid="table_name"/>        <where>            docId = #{carId} AND productType = #{productType} ORDER BY createAt DESC LIMIT 1        </where>    </select></mapper>